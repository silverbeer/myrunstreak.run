# ==============================================================================
# GitHub Actions Workflow - Lambda Container Deployment
# ==============================================================================
# This workflow builds and deploys Lambda functions as container images.
# Uses ECR for container registry and solves Pydantic compatibility issues.
#
# Triggers:
# - Push to main branch (when PR is merged)
# - Only if Lambda code or dependencies changed
# - Manual workflow dispatch
#
# What it does:
# 1. Check out code
# 2. Run code quality checks (linting, type checking, tests)
# 3. Log in to Amazon ECR
# 4. Build Docker images for each Lambda
# 5. Push images to ECR
# 6. Update Lambda functions to use new images
# 7. Run smoke tests
#
# Benefits of container deployment:
# - Full control over Python environment
# - No Pydantic/compiled extension compatibility issues
# - Reproducible builds
# - Larger size limit (10 GB vs 250 MB)
# ==============================================================================

name: "Deploy Lambda Function"

on:
  # Run when Lambda code is pushed to main
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "pyproject.toml"
      - "uv.lock"
      - "Dockerfile"
      - ".github/workflows/lambda-deploy.yml"

  # Allow manual trigger
  workflow_dispatch:

# Required for OIDC authentication with AWS
permissions:
  id-token: write
  contents: read

# Environment variables
env:
  AWS_REGION: us-east-2
  PYTHON_VERSION: "3.12"
  AWS_ACCOUNT_ID: "855323747881"

jobs:
  # ==========================================================================
  # Job 1: Code Quality Checks
  # ==========================================================================
  code-quality:
    name: "Code Quality"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Dev Dependencies
        run: uv sync --all-extras

      - name: Run Ruff Linting
        run: |
          uv run ruff check .
          echo "âœ… Ruff linting passed"

      - name: Run Mypy Type Checking
        run: |
          uv run mypy src/lambdas src/shared
          echo "âœ… Mypy type checking passed"

      - name: Run Tests
        run: |
          uv run pytest
          echo "âœ… All tests passed"

  # ==========================================================================
  # Job 2: Build and Deploy Lambda Containers
  # ==========================================================================
  deploy-lambda:
    name: "Deploy ${{ matrix.lambda.name }}"
    runs-on: ubuntu-latest
    needs: code-quality

    strategy:
      matrix:
        lambda:
          - name: "Sync Lambda"
            function_name: myrunstreak-sync-runner-dev
            handler_module: sync_runs
            ecr_repository: myrunstreak-sync-dev
          - name: "Query Lambda"
            function_name: myrunstreak-query-runner-dev
            handler_module: query_runs
            ecr_repository: myrunstreak-query-dev

    steps:
      # ========================================================================
      # Step 1: Check out code
      # ========================================================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ========================================================================
      # Step 2: Configure AWS Credentials
      # ========================================================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_LAMBDA_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ========================================================================
      # Step 3: Login to Amazon ECR
      # ========================================================================
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ========================================================================
      # Step 4: Set up Docker Buildx
      # ========================================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ========================================================================
      # Step 5: Build and Push Docker Image
      # ========================================================================
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64
          provenance: false
          tags: |
            ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ matrix.lambda.ecr_repository }}:latest
            ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ matrix.lambda.ecr_repository }}:${{ github.sha }}
          build-args: |
            HANDLER_MODULE=${{ matrix.lambda.handler_module }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ========================================================================
      # Step 6: Update Lambda Function
      # ========================================================================
      - name: Update Lambda function
        id: deploy
        run: |
          # Update Lambda to use new image
          aws lambda update-function-code \
            --function-name ${{ matrix.lambda.function_name }} \
            --image-uri ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ matrix.lambda.ecr_repository }}:${{ github.sha }}

          # Wait for update to complete
          aws lambda wait function-updated \
            --function-name ${{ matrix.lambda.function_name }}

          echo "âœ… Lambda function updated successfully"

      # ========================================================================
      # Step 7: Get Function Info
      # ========================================================================
      - name: Get Function Info
        id: function-info
        run: |
          CONFIG=$(aws lambda get-function-configuration \
            --function-name ${{ matrix.lambda.function_name }})

          VERSION=$(echo $CONFIG | jq -r '.Version')
          CODE_SIZE=$(echo $CONFIG | jq -r '.CodeSize')

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "code_size=$CODE_SIZE" >> $GITHUB_OUTPUT

      # ========================================================================
      # Step 8: Run Smoke Test
      # ========================================================================
      - name: Smoke Test
        id: test
        run: |
          RESULT=$(aws lambda invoke \
            --function-name ${{ matrix.lambda.function_name }} \
            --payload '{"source":"github-actions","action":"smoke-test"}' \
            --cli-binary-format raw-in-base64-out \
            response.json)

          if echo $RESULT | jq -e '.FunctionError' > /dev/null; then
            echo "âŒ Lambda invocation failed"
            cat response.json
            exit 1
          fi

          echo "âœ… Smoke test passed"
          cat response.json

      # ========================================================================
      # Step 9: Create Deployment Summary
      # ========================================================================
      - name: Create Deployment Summary
        if: steps.deploy.outcome == 'success'
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸš€ ${{ matrix.lambda.name }} Deployed (Container)

          **Function:** \`${{ matrix.lambda.function_name }}\`
          **Image:** \`${{ matrix.lambda.ecr_repository }}:${{ github.sha }}\`
          **Code Size:** $((${{ steps.function-info.outputs.code_size }} / 1024 / 1024)) MB
          **Deployed At:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Deployed By:** @${{ github.actor }}

          ---

          ### âœ… Smoke Test Results

          Lambda function invoked successfully and returned expected response.

          ---

          ### ðŸ“Š AWS Console Links

          - [Lambda Function](https://console.aws.amazon.com/lambda/home?region=${{ env.AWS_REGION }}#/functions/${{ matrix.lambda.function_name }})
          - [ECR Repository](https://console.aws.amazon.com/ecr/repositories/private/${{ env.AWS_ACCOUNT_ID }}/${{ matrix.lambda.ecr_repository }}?region=${{ env.AWS_REGION }})
          - [CloudWatch Logs](https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#logsV2:log-groups/log-group/\$252Faws\$252Flambda\$252F${{ matrix.lambda.function_name }})

          ---

          ### ðŸ§ª Test the Deployment

          \`\`\`bash
          # Via AWS CLI
          aws lambda invoke --function-name ${{ matrix.lambda.function_name }} \\
            --payload '{"action":"test"}' response.json
          \`\`\`

          EOF
