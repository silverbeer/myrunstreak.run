# ==============================================================================
# GitHub Actions Workflow - Terraform Apply
# ==============================================================================
# This workflow runs when changes are merged to main branch.
# It applies Terraform configuration to deploy infrastructure changes to AWS.
#
# Triggers:
# - Push to main branch (when PR is merged)
# - Only if Terraform files changed
# - Manual workflow dispatch (can run manually - USE WITH CAUTION)
#
# What it does:
# 1. Check out code
# 2. Set up Terraform
# 3. Initialize Terraform
# 4. Run terraform apply (with auto-approve)
# 5. Save outputs
# 6. Post deployment summary
#
# Security:
# - Uses OpenID Connect (OIDC) for AWS authentication
# - Requires approval for production deployments (optional protection rule)
# - Auto-approve ONLY on main branch after PR merge
#
# Safety:
# - Always run terraform plan in PR first!
# - This workflow auto-approves (no manual confirmation)
# - Only approved changes should be merged to main
#
# Learning Points:
# - Terraform apply with auto-approve
# - GitHub Actions outputs
# - Deployment summaries
# - Environment protection rules
# ==============================================================================

name: "Terraform Apply"

on:
  # Run when code is pushed to main (PR merge)
  push:
    branches:
      - main
    paths:
      - "terraform/**"
      - ".github/workflows/terraform-apply.yml"

  # Allow manual trigger (USE WITH CAUTION - bypasses PR review)
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "apply" to confirm manual deployment'
        required: true
        type: string

# Required for OIDC authentication with AWS
permissions:
  id-token: write      # Required to request JWT for OIDC
  contents: read       # Required to check out code
  pull-requests: write # Post comments on related PRs

# Environment variables
env:
  AWS_REGION: us-east-2
  TERRAFORM_VERSION: "1.13.5"

jobs:
  terraform-apply:
    name: "Terraform Apply"
    runs-on: ubuntu-latest

    # Use GitHub Environments for additional protection
    # Uncomment to require manual approval before apply
    # environment:
    #   name: dev
    #   url: https://console.aws.amazon.com/lambda/home?region=us-east-2

    defaults:
      run:
        working-directory: terraform/environments/dev

    steps:
      # ========================================================================
      # Step 1: Safety Check for Manual Dispatch
      # ========================================================================
      # If manually triggered, require confirmation

      - name: Verify Manual Confirmation
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "apply" ]; then
            echo "âŒ Manual confirmation failed. Must type 'apply' to proceed."
            exit 1
          fi
          echo "âœ… Manual confirmation received"

      # ========================================================================
      # Step 2: Check out code
      # ========================================================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ========================================================================
      # Step 3: Configure AWS credentials using OIDC
      # ========================================================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ========================================================================
      # Step 4: Set up Terraform
      # ========================================================================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false  # Disable wrapper to parse outputs

      # ========================================================================
      # Step 5: Terraform Init
      # ========================================================================
      - name: Terraform Init
        id: init
        run: terraform init

      # ========================================================================
      # Step 6: Terraform Plan
      # ========================================================================
      # Always run plan before apply (safety check)

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false -out=tfplan
        env:
          TF_VAR_smashrun_client_id: ${{ secrets.SMASHRUN_CLIENT_ID }}
          TF_VAR_smashrun_client_secret: ${{ secrets.SMASHRUN_CLIENT_SECRET }}
          TF_VAR_smashrun_access_token: ${{ secrets.SMASHRUN_ACCESS_TOKEN }}
          TF_VAR_smashrun_refresh_token: ${{ secrets.SMASHRUN_REFRESH_TOKEN }}
          TF_VAR_api_key_personal: ${{ secrets.API_KEY_PERSONAL }}
          TF_VAR_supabase_url: ${{ secrets.SUPABASE_URL }}
          TF_VAR_supabase_service_role_key: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          # Use S3 for Lambda packages in CI/CD
          TF_VAR_lambda_s3_bucket: myrunstreak-data-dev-855323747881

      # ========================================================================
      # Step 7: Terraform Apply
      # ========================================================================
      # Apply the planned changes
      # -auto-approve: No manual confirmation (changes already reviewed in PR)

      - name: Terraform Apply
        id: apply
        run: terraform apply -no-color -input=false tfplan

      # Why auto-approve is safe here:
      # 1. Changes were reviewed in PR
      # 2. Plan was generated in previous step (we know what will happen)
      # 3. Only runs on main branch (protected)
      # 4. GitHub branch protection ensures PR approval

      # ========================================================================
      # Step 8: Capture Terraform Outputs
      # ========================================================================
      # Save outputs for use in summary/comments

      - name: Capture Terraform Outputs
        id: outputs
        if: steps.apply.outcome == 'success'
        run: |
          # Get all outputs as JSON
          OUTPUTS=$(terraform output -json)

          # Extract specific outputs for display
          API_URL=$(echo $OUTPUTS | jq -r '.api_gateway_url.value // "Not available"')
          SYNC_ENDPOINT=$(echo $OUTPUTS | jq -r '.api_sync_endpoint.value // "Not available"')
          HEALTH_ENDPOINT=$(echo $OUTPUTS | jq -r '.api_health_endpoint.value // "Not available"')
          LAMBDA_NAME=$(echo $OUTPUTS | jq -r '.lambda_function_name.value // "Not available"')
          S3_BUCKET=$(echo $OUTPUTS | jq -r '.s3_bucket_name.value // "Not available"')

          # Set outputs for later steps
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "sync_endpoint=$SYNC_ENDPOINT" >> $GITHUB_OUTPUT
          echo "health_endpoint=$HEALTH_ENDPOINT" >> $GITHUB_OUTPUT
          echo "lambda_name=$LAMBDA_NAME" >> $GITHUB_OUTPUT
          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT

      # ========================================================================
      # Step 9: Create Deployment Summary
      # ========================================================================
      # Post-deployment information in GitHub Actions summary

      - name: Create Deployment Summary
        if: steps.apply.outcome == 'success'
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸš€ Terraform Deployment Successful

          **Environment:** dev
          **AWS Region:** ${{ env.AWS_REGION }}
          **Deployed At:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Triggered By:** @${{ github.actor }}

          ---

          ### ðŸ“ API Endpoints

          | Endpoint | URL |
          |----------|-----|
          | **Health Check** | ${{ steps.outputs.outputs.health_endpoint }} |
          | **Sync (Manual)** | ${{ steps.outputs.outputs.sync_endpoint }} |

          ---

          ### ðŸ”§ Resources Deployed

          - **Lambda Function:** \`${{ steps.outputs.outputs.lambda_name }}\`
          - **S3 Bucket:** \`${{ steps.outputs.outputs.s3_bucket }}\`
          - **API Gateway:** Deployed to dev stage

          ---

          ### â­ï¸ Next Steps

          1. **Test Health Endpoint:**
             \`\`\`bash
             curl ${{ steps.outputs.outputs.health_endpoint }}
             \`\`\`

          2. **Upload Initial Database:**
             \`\`\`bash
             aws s3 cp data/runs.duckdb s3://${{ steps.outputs.outputs.s3_bucket }}/runs.duckdb
             \`\`\`

          3. **Get API Key:**
             \`\`\`bash
             terraform output -raw api_key_value
             \`\`\`

          4. **View Lambda Logs:**
             \`\`\`bash
             aws logs tail /aws/lambda/${{ steps.outputs.outputs.lambda_name }} --follow
             \`\`\`

          ---

          ### ðŸ“Š AWS Console Links

          - [Lambda Function](https://console.aws.amazon.com/lambda/home?region=${{ env.AWS_REGION }}#/functions/${{ steps.outputs.outputs.lambda_name }})
          - [API Gateway](https://console.aws.amazon.com/apigateway/home?region=${{ env.AWS_REGION }})
          - [CloudWatch Logs](https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#logsV2:log-groups)
          - [S3 Bucket](https://s3.console.aws.amazon.com/s3/buckets/${{ steps.outputs.outputs.s3_bucket }})

          EOF

      # ========================================================================
      # Step 10: Handle Apply Failure
      # ========================================================================
      - name: Deployment Failed
        if: steps.apply.outcome == 'failure'
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âŒ Terraform Deployment Failed

          **Environment:** dev
          **Failed At:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Triggered By:** @${{ github.actor }}

          ---

          ### ðŸ” Troubleshooting

          1. Check the error output above
          2. Review CloudWatch Logs
          3. Verify AWS credentials and permissions
          4. Check Terraform state lock (DynamoDB)

          ### ðŸ”„ Recovery

          If state is locked, you may need to force unlock:
          \`\`\`bash
          terraform force-unlock <LOCK_ID>
          \`\`\`

          **Use with caution!** Only force unlock if you're certain no other process is running.

          EOF

          exit 1
