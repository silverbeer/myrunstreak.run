# ==============================================================================
# GitHub Actions Workflow - Terraform Plan
# ==============================================================================
# This workflow runs on pull requests to show what infrastructure changes
# will be made before they're applied.
#
# Triggers:
# - Pull requests that modify Terraform files
# - Manual workflow dispatch (can run manually)
#
# What it does:
# 1. Check out code
# 2. Set up Terraform
# 3. Format check (terraform fmt -check)
# 4. Initialize Terraform (downloads providers, sets up backend)
# 5. Validate Terraform syntax
# 6. Run terraform plan
# 7. Post plan as PR comment (so reviewers can see changes)
#
# Security:
# - Uses OpenID Connect (OIDC) for AWS authentication (no long-lived credentials)
# - Read-only permissions for code
# - Write permission for PR comments only
#
# Learning Points:
# - GitHub Actions workflow syntax
# - Terraform CLI commands
# - AWS OIDC authentication
# - PR comments via GitHub API
# ==============================================================================

name: "Terraform Plan"

on:
  # Run on pull requests that change Terraform files
  pull_request:
    branches:
      - main
      - feature/*
    paths:
      - "terraform/**"
      - ".github/workflows/terraform-plan.yml"

  # Allow manual trigger from GitHub UI
  workflow_dispatch:

# Required for OIDC authentication with AWS
permissions:
  id-token: write   # Required to request JWT for OIDC
  contents: read    # Required to check out code
  pull-requests: write  # Required to comment on PRs

# Environment variables available to all jobs
env:
  AWS_REGION: us-east-2
  TERRAFORM_VERSION: "1.13.5"

jobs:
  terraform-plan:
    name: "Terraform Plan"
    runs-on: ubuntu-latest

    # Set working directory for all steps
    defaults:
      run:
        working-directory: terraform/environments/dev

    steps:
      # ========================================================================
      # Step 1: Check out code
      # ========================================================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ========================================================================
      # Step 2: Configure AWS credentials using OIDC
      # ========================================================================
      # OIDC is more secure than storing AWS access keys as secrets
      # GitHub generates a temporary token, AWS validates it, returns temp credentials

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          # Temporary credentials are valid for this job only

      # What's needed in AWS:
      # 1. IAM OIDC Identity Provider (trust GitHub)
      # 2. IAM Role with Terraform permissions
      # 3. Trust policy that allows GitHub Actions to assume the role

      # ========================================================================
      # Step 3: Set up Terraform
      # ========================================================================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          # terraform_wrapper: false  # Set to false if parsing outputs in scripts

      # ========================================================================
      # Step 4: Terraform Format Check
      # ========================================================================
      # Ensure code follows Terraform formatting standards
      # Fails if any files need formatting

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true
        # continue-on-error allows workflow to continue even if formatting fails
        # We'll report it in the PR comment but not block

      # ========================================================================
      # Step 5: Terraform Init
      # ========================================================================
      # Download providers, modules, and configure backend (S3)

      - name: Terraform Init
        id: init
        run: terraform init
        # This connects to S3 backend for remote state
        # Requires AWS credentials (configured in step 2)

      # ========================================================================
      # Step 6: Terraform Validate
      # ========================================================================
      # Check for syntax errors and configuration issues

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      # ========================================================================
      # Step 7: Terraform Plan
      # ========================================================================
      # Generate execution plan showing what will change

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -input=false -out=tfplan
          terraform show -no-color tfplan > plan_output.txt
        env:
          # Pass sensitive variables from GitHub Secrets
          TF_VAR_smashrun_client_id: ${{ secrets.SMASHRUN_CLIENT_ID }}
          TF_VAR_smashrun_client_secret: ${{ secrets.SMASHRUN_CLIENT_SECRET }}
          TF_VAR_smashrun_access_token: ${{ secrets.SMASHRUN_ACCESS_TOKEN }}
          TF_VAR_smashrun_refresh_token: ${{ secrets.SMASHRUN_REFRESH_TOKEN }}
          TF_VAR_api_key_personal: ${{ secrets.API_KEY_PERSONAL }}
          TF_VAR_supabase_url: ${{ secrets.SUPABASE_URL }}
          TF_VAR_supabase_service_role_key: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          # Use S3 for Lambda packages in CI/CD
          TF_VAR_lambda_s3_bucket: myrunstreak-data-dev-855323747881
        continue-on-error: true
        # Save exit code to determine success/failure later

      # ========================================================================
      # Step 8: Upload Plan Artifact
      # ========================================================================
      # Save plan file so it can be downloaded for review

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        if: steps.plan.outcome == 'success'
        with:
          name: terraform-plan
          path: terraform/environments/dev/tfplan
          retention-days: 5

      # ========================================================================
      # Step 9: Post Plan to PR Comment
      # ========================================================================
      # Show plan results as a comment on the pull request

      - name: Post Plan to PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform/environments/dev/plan_output.txt', 'utf8');

            // Build comment body
            let output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${plan}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Working Directory: \`terraform/environments/dev\`, Workflow: \`${{ github.workflow }}\`*`;

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      # ========================================================================
      # Step 10: Fail if Plan Failed
      # ========================================================================
      # After posting comment, fail the workflow if plan failed

      - name: Check Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1
